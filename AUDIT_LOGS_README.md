# üìã H·ªá Th·ªëng Audit Logs (L·ªãch S·ª≠ Thao T√°c)

## T·ªïng Quan
H·ªá th·ªëng audit logs t·ª± ƒë·ªông ghi l·∫°i m·ªçi h√†nh ƒë·ªông th√™m/s·ª≠a/x√≥a trong h·ªá th·ªëng, gi√∫p:
- **Truy v·∫øt**: Ai l√†m g√¨, khi n√†o, ·ªü ƒë√¢u
- **B·∫£o m·∫≠t**: Ph√°t hi·ªán h√†nh vi b·∫•t th∆∞·ªùng
- **Tu√¢n th·ªß**: ƒê√°p ·ª©ng y√™u c·∫ßu audit
- **Rollback**: Xem l·∫°i tr·∫°ng th√°i tr∆∞·ªõc khi thay ƒë·ªïi

## C√°c Th√†nh Ph·∫ßn

### 1. Database Table
```sql
CREATE TABLE audit_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  actor_user_id BIGINT NULL,           -- Ng∆∞·ªùi th·ª±c hi·ªán
  entity_type VARCHAR(64) NOT NULL,    -- Lo·∫°i ƒë·ªëi t∆∞·ª£ng (products, orders, ...)
  entity_id BIGINT NOT NULL,           -- ID c·ªßa ƒë·ªëi t∆∞·ª£ng
  action VARCHAR(32) NOT NULL,         -- H√†nh ƒë·ªông (create, update, delete, ...)
  before_data JSON,                    -- D·ªØ li·ªáu TR∆Ø·ªöC khi thay ƒë·ªïi
  after_data JSON,                     -- D·ªØ li·ªáu SAU khi thay ƒë·ªïi
  created_at DATETIME NOT NULL,
  INDEX idx_audit_entity (entity_type, entity_id),
  CONSTRAINT fk_audit_user FOREIGN KEY(actor_user_id) REFERENCES users(id)
) ENGINE=InnoDB;
```

### 2. AuditLogRepository
**File**: `src/Models/Repositories/AuditLogRepository.php`

**C√°c method ch√≠nh**:
- `log()` - Ghi log
- `all()` - L·∫•y to√†n b·ªô logs v·ªõi filter
- `getByEntity()` - L·∫•y logs c·ªßa 1 entity c·ª• th·ªÉ
- `getByUser()` - L·∫•y logs c·ªßa 1 user
- `statsByAction()` - Th·ªëng k√™ theo h√†nh ƒë·ªông
- `statsByEntity()` - Th·ªëng k√™ theo ƒë·ªëi t∆∞·ª£ng
- `statsByUser()` - Th·ªëng k√™ theo ng∆∞·ªùi d√πng

### 3. Auditable Trait
**File**: `src/Support/Auditable.php`

Trait gi√∫p d·ªÖ d√†ng th√™m audit log v√†o c√°c Repository.

**C√°ch s·ª≠ d·ª•ng**:

```php
<?php
namespace App\Models\Repositories;

use App\Support\Auditable;

class ProductRepository
{
    use Auditable;

    public function create(array $data, int $currentUser): int
    {
        // ... logic t·∫°o s·∫£n ph·∫©m ...
        $id = (int) $pdo->lastInsertId();
        
        // Ghi log
        $this->logCreate('products', $id, $data, $currentUser);
        
        return $id;
    }

    public function update(int $id, array $data, int $currentUser): void
    {
        // L·∫•y d·ªØ li·ªáu c≈©
        $beforeData = $this->findOne($id);
        
        // ... logic update ...
        
        // Ghi log
        if ($beforeData) {
            $this->logUpdate('products', $id, $beforeData, $data, $currentUser);
        }
    }

    public function delete(int $id, ?int $currentUser = null): void
    {
        // L·∫•y d·ªØ li·ªáu tr∆∞·ªõc khi x√≥a
        $beforeData = $this->findOne($id);
        
        // ... logic x√≥a ...
        
        // Ghi log
        if ($beforeData) {
            $this->logDelete('products', $id, $beforeData, $currentUser);
        }
    }
}
```

**C√°c method c√≥ s·∫µn**:
- `logCreate($entityType, $entityId, $afterData, $actorUserId)` - Log t·∫°o m·ªõi
- `logUpdate($entityType, $entityId, $beforeData, $afterData, $actorUserId)` - Log c·∫≠p nh·∫≠t
- `logDelete($entityType, $entityId, $beforeData, $actorUserId)` - Log x√≥a
- `logRestore($entityType, $entityId, $afterData, $actorUserId)` - Log kh√¥i ph·ª•c
- `logStatusChange($entityType, $entityId, $oldStatus, $newStatus, $actorUserId)` - Log ƒë·ªïi tr·∫°ng th√°i

### 4. Controller & View
**File**: 
- Controller: `src/Controllers/Admin/AuditLogController.php`
- View: `src/views/admin/audit-logs/audit-log.php`

**Routes**:
```
GET  /admin/audit-logs                      - Giao di·ªán xem logs
GET  /admin/api/audit-logs                  - API l·∫•y danh s√°ch logs
GET  /admin/api/audit-logs/entity/{type}/{id} - Logs c·ªßa 1 entity
GET  /admin/api/audit-logs/stats/action     - Th·ªëng k√™ theo action
GET  /admin/api/audit-logs/stats/entity     - Th·ªëng k√™ theo entity
GET  /admin/api/audit-logs/stats/user       - Th·ªëng k√™ theo user
```

## T√≠nh NƒÉng Giao Di·ªán

### 1. B·ªô L·ªçc M·∫°nh M·∫Ω
- **T√¨m ki·∫øm**: T√¨m theo t√™n ng∆∞·ªùi d√πng, n·ªôi dung
- **Lo·∫°i ƒë·ªëi t∆∞·ª£ng**: S·∫£n ph·∫©m, ƒë∆°n h√†ng, ng∆∞·ªùi d√πng, ...
- **H√†nh ƒë·ªông**: Th√™m, s·ª≠a, x√≥a, kh√¥i ph·ª•c, ƒë·ªïi tr·∫°ng th√°i
- **Kho·∫£ng th·ªùi gian**: T·ª´ ng√†y - ƒë·∫øn ng√†y
- **Ng∆∞·ªùi th·ª±c hi·ªán**: L·ªçc theo user ID

### 2. Xem Chi Ti·∫øt
- So s√°nh **TR∆Ø·ªöC** v√† **SAU** khi thay ƒë·ªïi
- Hi·ªÉn th·ªã JSON format ƒë·∫πp, d·ªÖ ƒë·ªçc
- M√†u ƒë·ªè cho d·ªØ li·ªáu c≈©, xanh cho d·ªØ li·ªáu m·ªõi

### 3. Th·ªëng K√™
- **Theo h√†nh ƒë·ªông**: Bao nhi√™u l·∫ßn create/update/delete
- **Theo ƒë·ªëi t∆∞·ª£ng**: ƒê·ªëi t∆∞·ª£ng n√†o b·ªã thao t√°c nhi·ªÅu nh·∫•t
- **Theo ng∆∞·ªùi d√πng**: Top ng∆∞·ªùi d√πng active nh·∫•t

### 4. Ph√¢n Trang
- Hi·ªÉn th·ªã 20 b·∫£n ghi/trang
- ƒêi·ªÅu h∆∞·ªõng tr∆∞·ªõc/sau d·ªÖ d√†ng
- Hi·ªÉn th·ªã t·ªïng s·ªë b·∫£n ghi

## C√°ch Tri·ªÉn Khai

### B∆∞·ªõc 1: Database ƒë√£ c√≥ s·∫µn
Table `audit_logs` ƒë√£ ƒë∆∞·ª£c t·∫°o trong `db.sql`.

### B∆∞·ªõc 2: √Åp D·ª•ng Audit cho Repository

**V√≠ d·ª• v·ªõi ProductRepository**:

```php
<?php
namespace App\Models\Repositories;

use App\Core\DB;
use App\Support\Auditable;

class ProductRepository
{
    use Auditable;  // <-- Th√™m trait n√†y

    public function create(array $data, int $currentUser): int
    {
        $pdo = DB::pdo();
        // ... INSERT logic ...
        $id = (int) $pdo->lastInsertId();
        
        // Ghi log audit
        $this->logCreate('products', $id, $data, $currentUser);
        
        return $id;
    }

    public function update(int $id, array $data, int $currentUser): void
    {
        $beforeData = $this->findOne($id);  // L·∫•y data c≈©
        
        $pdo = DB::pdo();
        // ... UPDATE logic ...
        
        // Ghi log audit
        if ($beforeData) {
            $this->logUpdate('products', $id, $beforeData, $data, $currentUser);
        }
    }

    public function delete(int $id, ?int $currentUser = null): void
    {
        $beforeData = $this->findOne($id);  // L·∫•y data tr∆∞·ªõc khi x√≥a
        
        $pdo = DB::pdo();
        // ... DELETE logic ...
        
        // Ghi log audit
        if ($beforeData) {
            $this->logDelete('products', $id, $beforeData, $currentUser);
        }
    }
}
```

### B∆∞·ªõc 3: √Åp D·ª•ng cho C√°c Repository Kh√°c

L√†m t∆∞∆°ng t·ª± cho:
- ‚úÖ **CouponRepository** (ƒë√£ √°p d·ª•ng)
- ‚è≥ **PromotionRepository**
- ‚è≥ **ProductRepository**
- ‚è≥ **CategoryRepository**
- ‚è≥ **BrandRepository**
- ‚è≥ **SupplierRepository**
- ‚è≥ **OrderRepository**
- ‚è≥ **PurchaseOrderRepository**
- ‚è≥ **UserRepository** (StaffRepository, CustomerRepository)

### B∆∞·ªõc 4: Truy C·∫≠p

1. ƒêƒÉng nh·∫≠p admin
2. V√†o `/admin/audit-logs`
3. Xem l·ªãch s·ª≠, l·ªçc, xem chi ti·∫øt, xem th·ªëng k√™

## Entity Types Mapping

| Entity Type | M√¥ T·∫£ | Repository |
|------------|-------|------------|
| `products` | S·∫£n ph·∫©m | ProductRepository |
| `categories` | Danh m·ª•c | CategoryRepository |
| `brands` | Th∆∞∆°ng hi·ªáu | BrandRepository |
| `suppliers` | Nh√† cung c·∫•p | SupplierRepository |
| `orders` | ƒê∆°n h√†ng | OrderRepository |
| `users` | Ng∆∞·ªùi d√πng | UserRepository |
| `coupons` | M√£ gi·∫£m gi√° | CouponRepository |
| `promotions` | Khuy·∫øn m√£i | PromotionRepository |
| `purchase_orders` | Phi·∫øu nh·∫≠p | PurchaseOrderRepository |
| `product_batches` | L√¥ h√†ng | ProductBatchRepository |
| `stock_outs` | Phi·∫øu xu·∫•t | StockOutRepository |
| `expense_vouchers` | Phi·∫øu chi | ExpenseVoucherRepository |
| `receipt_vouchers` | Phi·∫øu thu | ReceiptVoucherRepository |

## Action Types

| Action | M√¥ T·∫£ | Badge Color |
|--------|-------|-------------|
| `create` | Th√™m m·ªõi | üü¢ Green |
| `update` | C·∫≠p nh·∫≠t | üîµ Blue |
| `delete` | X√≥a | üî¥ Red |
| `restore` | Kh√¥i ph·ª•c | üü° Yellow |
| `status_change` | ƒê·ªïi tr·∫°ng th√°i | üü£ Purple |

## Best Practices

### 1. Lu√¥n L·∫•y Data C≈© Tr∆∞·ªõc Khi Update/Delete
```php
// ‚úÖ ƒê√öNG
$beforeData = $this->findOne($id);
// ... update logic ...
$this->logUpdate('products', $id, $beforeData, $data, $currentUser);

// ‚ùå SAI - Kh√¥ng c√≥ beforeData
$this->logUpdate('products', $id, [], $data, $currentUser);
```

### 2. Ch·ªâ Log Nh·ªØng Tr∆∞·ªùng Quan Tr·ªçng
```php
// B·ªè c√°c tr∆∞·ªùng kh√¥ng c·∫ßn thi·∫øt
unset($data['created_at']);
unset($data['updated_at']);
unset($data['created_by_name']);
unset($data['updated_by_name']);

$this->logUpdate('products', $id, $beforeData, $data, $currentUser);
```

### 3. S·ª≠ D·ª•ng Transaction Khi Log
```php
try {
    $pdo->beginTransaction();
    
    // ... business logic ...
    $id = $pdo->lastInsertId();
    
    // Log audit
    $this->logCreate('products', $id, $data, $currentUser);
    
    $pdo->commit();
} catch (\Exception $e) {
    $pdo->rollBack();
    throw $e;
}
```

### 4. Log Status Change Ri√™ng
```php
// Khi ch·ªâ ƒë·ªïi tr·∫°ng th√°i, d√πng logStatusChange
$oldStatus = $order['status'];
// ... update status ...
$newStatus = 'completed';

$this->logStatusChange('orders', $id, $oldStatus, $newStatus, $currentUser);
```

## Performance Tips

### 1. Index
Database ƒë√£ c√≥ index t·ªët:
```sql
INDEX idx_audit_entity (entity_type, entity_id)
```

### 2. Ph√¢n Trang
View ƒë√£ c√≥ pagination (20 records/page).

### 3. Cleanup Old Logs
N√™n c√≥ cronjob x√≥a logs c≈© (> 1 nƒÉm):
```sql
DELETE FROM audit_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### 4. Archive
V·ªõi h·ªá th·ªëng l·ªõn, n√™n archive logs sang b·∫£ng kh√°c:
```sql
CREATE TABLE audit_logs_archive LIKE audit_logs;
INSERT INTO audit_logs_archive SELECT * FROM audit_logs WHERE created_at < '2024-01-01';
DELETE FROM audit_logs WHERE created_at < '2024-01-01';
```

## V√≠ D·ª• S·ª≠ D·ª•ng API

### L·∫•y logs c·ªßa 1 s·∫£n ph·∫©m
```javascript
fetch('/admin/api/audit-logs/entity/products/123')
  .then(res => res.json())
  .then(data => console.log(data.items));
```

### L·∫•y logs v·ªõi filter
```javascript
const params = new URLSearchParams({
  entity_type: 'orders',
  action: 'create',
  from_date: '2024-10-01',
  to_date: '2024-10-31'
});

fetch(`/admin/api/audit-logs?${params}`)
  .then(res => res.json())
  .then(data => console.log(data.items));
```

### L·∫•y th·ªëng k√™
```javascript
fetch('/admin/api/audit-logs/stats/user')
  .then(res => res.json())
  .then(data => console.log(data.stats));
```

## Troubleshooting

### Logs kh√¥ng ƒë∆∞·ª£c ghi
1. Ki·ªÉm tra table `audit_logs` ƒë√£ t·∫°o ch∆∞a
2. Ki·ªÉm tra Repository ƒë√£ `use Auditable` ch∆∞a
3. Ki·ªÉm tra ƒë√£ g·ªçi `logCreate/Update/Delete` ch∆∞a
4. Ki·ªÉm tra `$currentUser` c√≥ ƒë√∫ng kh√¥ng

### L·ªói foreign key
- `actor_user_id` ph·∫£i t·ªìn t·∫°i trong `users` table
- Ho·∫∑c set `actor_user_id = NULL` n·∫øu l√† system action

### View kh√¥ng hi·ªÉn th·ªã
- Ki·ªÉm tra routes ƒë√£ ƒëƒÉng k√Ω ch∆∞a
- Ki·ªÉm tra permission (ch·ªâ admin m·ªõi xem ƒë∆∞·ª£c)
- Ki·ªÉm tra console browser c√≥ l·ªói JS kh√¥ng

## T√≥m T·∫Øt

H·ªá th·ªëng audit logs gi√∫p:
- ‚úÖ T·ª± ƒë·ªông ghi l·∫°i m·ªçi thao t√°c
- ‚úÖ So s√°nh tr∆∞·ªõc/sau thay ƒë·ªïi
- ‚úÖ Th·ªëng k√™ chi ti·∫øt
- ‚úÖ D·ªÖ d√†ng t√≠ch h·ª£p v√†o repository
- ‚úÖ Giao di·ªán ƒë·∫πp, filter m·∫°nh m·∫Ω

**Access**: `/admin/audit-logs`
